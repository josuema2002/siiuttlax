{% extends "layouts/base.html" %}

{% block title %} Certificados {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
{% endblock stylesheets %}

{% block content %} 
<script>
  var dataA = '';
  var state = 0;
</script>
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Certificados de titulación</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="{{ request.PATHPROJECT }}">Home</a></li>
              <li class="breadcrumb-item"><a href="{{ request.PATHPROJECT }}/certificado/certificado-allC.html">Certificado</a></li>
              <li class="breadcrumb-item active">Form</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- SELECT2 EXAMPLE -->
        <form action="" class="card card-default" id="form" method="GET">
          {% csrf_token %}
          <div class="card-header">
            <h3 class="card-title">Generar certificado de titulación</h3>

            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <!-- <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button> -->
            </div>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label>Matricula</label>
                  <select class="select2"style="width: 100%;" id="selectA">
                    <option selected disabled="disabled">Ingrese la matricula del alumno</option>
                    {% for alumno in request.alumnos %}
                      {% if alumno.estadiasTSU_alumno == True or alumno.estadiasIngLic_alumno == True %}
                        {% if request.certificados %}
                          {% for certificado in request.certificados %}
                            {% if certificado.matricula_alumno_titulacion_id != alumno.matricula_alumno %}
                              <option value="{{ alumno.matricula_alumno }}">{{ alumno.matricula_alumno }}</option>
                            {% endif %}
                          {% endfor %}
                        {% else %}
                          <option value="{{ alumno.matricula_alumno }}">{{ alumno.matricula_alumno }}</option>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </select>
                  <p class="fs-6 text-light bg-warning mt-1 px-1 rounded">
                    Si no encuentra la matricula del alumno en el listado, es porque no es apto para generar el certificado de titulación o ya se ha generado el certificado.
                  </p>
                </div>
                <!-- /.form-group -->
              </div>
              <!-- /.col -->
              {% if request.form.errors %}
                <div class="alert alert-danger">
                  <ul>
                    {% for error in request.form.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                  <p>
                    Intente de nuevo, pero con datos correctos.
                  </p>
                </div>
              {% endif %}
            </div>
            <!-- /.row -->
            <!-- right column -->
          <div class="col-md-12 d-none" id="fieldsNewCertificado">
            <!-- general form elements disabled -->
            <div class="card card-warning">
              <div class="card-header">
                <h3 class="card-title">Verifique los datos del alumno</h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                {% for field in request.form %}
                  {% if field.name == 'periodo_escolar_init_titulacion' %}
                    <div class="row">
                      <div class="col-sm-12">
                        <!-- text input -->
                        <div class="form-group">
                          <label id="{{ field.name }}L">
                            <script>
                              setTimeout(()=>{
                                $('#{{ field.name }}L').html('{{ field.label }}'.split(" ").slice(0, -1).join(" "));
                                $('#{{ field.name }}').attr('placeholder', '{{ field.label }}'.split(" ").slice(0, -1).join(" "));
  
                                setInterval(() => {
                                  dataA && state == 1 &&
                                  $('#{{ field.name }}').val(dataA['{{ field.name }}'])
                                }, 500);
                                
                              }, 300);
                            </script>
                          </label>
                          <div class="input-group date" id="init" data-target-input="nearest">
                            <input type="text" placeholder="09/2020" class="form-control datetimepicker-input" data-target="#init" id="{{ field.name }}" name="{{ field.name }}"/>
                              <div class="input-group-append" data-target="#init" data-toggle="datetimepicker">
                                  <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                              </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% elif field.name == 'periodo_escolar_end_titulacion' %}
                    <div class="row">
                      <div class="col-sm-12">
                        <!-- text input -->
                        <div class="form-group">
                          <label id="{{ field.name }}L">
                            <script>
                              setTimeout(()=>{
                                $('#{{ field.name }}L').html('{{ field.label }}'.split(" ").slice(0, -1).join(" "));
                                $('#{{ field.name }}').attr('placeholder', '{{ field.label }}'.split(" ").slice(0, -1).join(" "));
  
                                setInterval(() => {
                                  dataA && state == 1 &&
                                  $('#{{ field.name }}').val(dataA['{{ field.name }}'])
                                }, 500);
                                
                              }, 300);
                            </script>
                          </label>
                          <div class="input-group date" id="end" data-target-input="nearest">
                            <input type="text" placeholder="09/2020" class="form-control datetimepicker-input" data-target="#end" id="{{ field.name }}" name="{{ field.name }}"/>
                              <div class="input-group-append" data-target="#end" data-toggle="datetimepicker">
                                  <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                              </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% elif field.name == 'calificaciones_titulacion' %}
                    <script>
                      setInterval(() => {
                        $('#{{ field.name }}').val(JSON.stringify(calificaciones))
                      }, 500);
                    </script>
                    <input type="text" placeholder="-" class="d-none" id="{{ field.name }}" name="{{ field.name }}"/>
                  {% elif field.name == 'matricula_alumno_titulacion' %}
                    <script>
                      setInterval(() => {
                        $('#{{ field.name }}').val(dataA['{{ field.name }}'])
                      }, 500);
                    </script>
                    <input type="hidden" placeholder="-" class="" id="{{ field.name }}" name="{{ field.name }}"/>
                  
                  {% else %}
                    <div class="row">
                      <div class="col-sm-12">
                        <div class="form-group">
                          <label id="{{ field.name }}L">
                            <script>
                              setTimeout(()=>{
                                $('#{{ field.name }}L').html('{{ field.label }}'.split(" ").slice(0, -1).join(" "));
                                $('#{{ field.name }}').attr('placeholder', '{{ field.label }}'.split(" ").slice(0, -1).join(" "));
  
                                setInterval(() => {
                                  dataA && state == 1 &&
                                  $('#{{ field.name }}').val(dataA['{{ field.name }}'])
                                }, 500);
                                
                              }, 300);
                            </script>
                          </label>
                          <input type="{{ field.field.widget.input_type }}" class="form-control" id="{{ field.name }}" name="{{ field.name }}" placeholder="{{ field.label }}" value="{{ field.value }}">
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
                
                <h5>Calificaciones</h5>

                <div class="btn btn-success" onclick="addCali()">
                  <i class="fas fa-plus px-1"></i> Agregar materia
                </div>
                <script>
                  function addCali() {
                    var cali = {
                      'materia': '',
                      'calificacion': 0
                    }
                    calificaciones.push(cali)

                    $('#tableCali').append(
                      '<tr>' +
                        '<td>' +
                          '<input type="text" class="form-control materia" name="materia[]" placeholder="Materia">' +
                        '</td>' +
                        '<td>' +
                          '<input type="text" class="form-control calificacion" name="calificacion[]" placeholder="Calificacion">' +
                        '</td>' +
                        '<td>' +
                          '<div class="btn btn-danger" onclick="deleteCali(this)" mat=""><i class="fas fa-trash"></i></div>' +
                        '</td>' +
                      '</tr>'
                    )

                    $('.materia').each(function(index, el) {
                      //cada vez que se agrega una materia se edite el array de calificaciones
                      el.onkeyup = function(event) {
                        calificaciones[index].materia = $(this).val().toString();
                        el.parentElement.parentElement.children[2].children[0].setAttribute('mat', $(this).val().toString());
                      }
                    });
                    $('.calificacion').each(function(index, el) {
                      //cada vez que se agrega una materia se edite el array de calificaciones
                      el.onkeyup = function(event) {
                        calificaciones[index].calificacion = parseInt($(this).val());
                      }
                    });
                  }
                </script>
                <table class="table table-bordered mb-3">
                  <thead class="thead-dark">
                    <tr>
                      <th>Materia</th>
                      <th>Calificación</th>
                      <th>Eliminar</th>
                    </tr>
                  </thead>
                  <tbody class="table-striped" id="tableCali">
                    <script>
                      var calificaciones = [];
                      setInterval(() => {
                        if(dataA && state == 1){
                          arrayCalificaciones = JSON.parse(dataA['calificaciones_titulacion']);
                            arrayCalificaciones.forEach((calificacion) => {
                              if (calificaciones.length < arrayCalificaciones.length){
                                calificaciones.push(calificacion);
                                $('#tableCali').append(
                                  '<tr>' +
                                    '<td>' +
                                      '<input type="text" class="form-control materia" name="materia[]" placeholder="Materia" value="'+calificacion['materia']+'">' +
                                    '</td>' +
                                    '<td>' +
                                      '<input type="text" class="form-control calificacion" name="calificacion[]" placeholder="Calificacion" value="'+calificacion['calificacion']+'">' +
                                    '</td>' +
                                    '<td>' +
                                      '<div class="btn btn-danger" onclick="deleteCali(this)" mat="' + calificacion['materia'] +'"><i class="fas fa-trash"></i></div>' +
                                    '</td>' +
                                  '</tr>'
                                );
                                }
                            });

                          $('.materia').each(function(index, el) {
                            //cada vez que se agrega una materia se edite el array de calificaciones
                            el.onkeyup = function(event) {
                              calificaciones[index].materia = $(this).val().toString();
                            }
                          });
                          $('.calificacion').each(function(index, el) {
                            //cada vez que se agrega una materia se edite el array de calificaciones
                            el.onkeyup = function(event) {
                              calificaciones[index].calificacion = parseInt($(this).val());
                            }
                          });
                        }
                      }, 500);
                      function deleteCali(e){
                        console.log(e);
                        calificaciones = calificaciones.filter((calificacion) => {
                          console.log(calificacion);
                          //minuscculas calificacion.materia
                          return calificacion.materia.toLowerCase() != e.getAttribute('mat').toLowerCase();
                        });

                        setTimeout(() => {
                          e.parentNode.parentNode.remove();
                        }, 500);

                      }
                    </script>
                  </tbody>
                </table>

                <div class="row">
                  <div class="col-sm-10">
                    <!-- checkbox -->
                    <div class="form-group">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="check">
                        <label class="form-check-label" for="check">Acepto que los datos estan bien.</label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-12">
                    <!-- checkbox -->
                    <div class="form-group">
                      <div class="form-check bg-warning rounded">
                        <label class="form-check-label">
                          Si los datos no son correctos, comunicarse con el area indicada.
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!--/.col (right) -->
          </div>
          <!-- /.card-body -->
          <div class="card-footer">
            <button class="btn btn-success btn-block d-none" id="btnGenerar" type="submit">
            Generar
          </button>
          </div>
        </form>
        <!-- /.card -->
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<!-- Page script -->
<script>
  $(
    function(){
      var Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000
      });
      $('#init').datetimepicker({
          viewMode: 'years',
          format: 'MM/YYYY'
      });
      $('#end').datetimepicker({
          viewMode: 'years',
          format: 'MM/YYYY'
      });
      $('#selectA').on('change', function() {
        //peticion ajax para obtener los datos del alumno en python
        $.ajax({
          url: '{{ request.PATHPROJECT }}/alumno1',
          type: 'POST',
          dataType: 'json',
          data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}',
            'matricula': $('#selectA').val()
          },
          success: function(resp) {
            $('#fieldsNewCertificado').removeClass('d-none');
            $('#btnGenerar').removeClass('d-none');
            dataA = resp;
            state = 1;
            setTimeout(function(){
              state = 0;
            }, 2000);
            
            
          },
          error: function(err) {
            console.log(err);
          }
        });

      });
    
      //evento a boton generar
      $('#form').on('submit', (e)=> {
        e.preventDefault();

        //recorrer cada input del formulario
        errors = 0
        $('#form input').each(function(index, value) {
          var input
          if(($(this).val() == '' || $(this).val() == undefined || $(this).val() == null) && $(this).attr('name')) {
            //input[$(this).attr('name')] = $(this).val();

            errors++;
          }
        });
        if (errors > 0){
          Toast.fire({
            icon: 'error',
            title: 'Faltan datos por llenar'
          });
        }else{
          if($('#check').is(':checked')){
          
            Toast.fire({
              icon: 'info',
              title: ' Generando...'
            })

            $.ajax({
              url: window.location.href,
              type: 'POST',
              dataType: 'json',
              data: $('#form').serialize(),
              success: function(resp) {
                console.log(resp);
                Toast.fire({
                  icon: 'success',
                  title: 'Certificado generado'
                });

                //crear pdf
                try {
                  // jsPdf
                  window.jsPDF = window.jspdf.jsPDF;
                  const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                  });

                  const margins = {
                    top: 58,
                    left: 32,
                    right: 32,
                    bottom: 0
                  };
                  
                  
                  doc.rect(margins.left + 4, margins.top, 25, 30, 'S');

                  doc.addFileToVFS('Avantgarde.ttf', fontsB64.avantgarde.normal);
                  doc.addFont('Avantgarde.ttf', 'avantgarde', 'normal');
                  doc.addFileToVFS('Avantgarde-b.ttf', fontsB64.avantgarde.bold);
                  doc.addFont('Avantgarde-b.ttf', 'avantgarde', 'bold');
                  doc.addFileToVFS('Avantgarde-i.ttf', fontsB64.avantgarde.italic);
                  doc.addFont('Avantgarde-i.ttf', 'avantgarde', 'italic');

                  doc.addFileToVFS('Arial.ttf', fontsB64.arial.normal);
                  doc.addFont('Arial.ttf', 'arial', 'normal');
                  doc.addFileToVFS('Arial-b.ttf', fontsB64.arial.bold);
                  doc.addFont('Arial-b.ttf', 'arial', 'bold');
                  
                  doc.setFontSize(14);
                  doc.setFont('avantgarde', 'bold');
                  doc.text(margins.left + 56, 3 + margins.top, 'CERTIFICADO DE ESTUDIOS');
                  doc.setFontSize(9);
                  doc.setFont('avantgarde', 'normal');
                  const textInit = `La Universidad Tecnológica certifica que según constancias existentes en el archivo escolar, el C. ${dataA.nombre_alumno_titulacion} ${dataA.apellidop_alumno_titulacion} ${dataA.apellidom_alumno_titulacion} con matrícula ${dataA.matricula_alumno_titulacion} cursó y aprobó las asignaturas que integran el plan de estudios ${dataA.anio_plan_estudios_titulacion} en el periodo escolar ${dataA.periodo_escolar_init_titulacion} - ${dataA.periodo_escolar_end_titulacion} de la carrera de ${dataA.tipo_carrera_titulacion} en ${dataA.carrera_titulacion} Area ${dataA.area_carrera_titulacion} obteniendo las calificaciones finales que a continuación se anotan:`
                  doc.text(margins.left + 40, 8 + margins.top, textInit,{ align: 'justify', maxWidth: 105});
                  
                  doc.setLineWidth(0.5);
                  doc.line(margins.left, margins.top + 35, margins.left + 146, margins.top + 35, 'FD');
                  doc.setLineWidth(0.3);
                  
                  // tabla de calificaciones
                  doc.line(margins.left, margins.top + 40, margins.left + 146, margins.top + 40, 'FD'); // - 1
                  doc.line(margins.left, margins.top + 40, margins.left, margins.top + 50, 'FD'); // | 1
                  doc.line(margins.left + 110, margins.top + 40, margins.left + 110, margins.top + 50, 'FD'); // | 2
                  doc.line(margins.left + 122, margins.top + 40, margins.left + 122, margins.top + 50, 'FD'); // | 3
                  doc.line(margins.left + 122, margins.top + 44, margins.left + 146, margins.top + 44, 'FD'); // - 2
                  doc.line(margins.left + 134, margins.top + 44, margins.left + 134, margins.top + 50, 'FD'); // | 4
                  doc.line(margins.left + 146, margins.top + 40, margins.left + 146, margins.top + 50, 'FD'); // | 5
                  doc.line(margins.left, margins.top + 50, margins.left + 146, margins.top + 50, 'FD'); // - 3
                  doc.setFontSize(7);
                  doc.setFont('avantgarde', 'bold');
                  doc.text(margins.left + 45, margins.top + 45, 'ASIGNATURAS'); // T 1
                  doc.text(margins.left + 112, margins.top + 45, 'HORAS'); // T 2
                  doc.text(margins.left + 125, margins.top + 42.5, 'CALIFICACIÓN'); // T 3
                  doc.text(margins.left + 122.5, margins.top + 47.5, 'NUMERO'); // T 4
                  doc.text(margins.left + 134.5, margins.top + 46.8, 'CALIFI-CACIÓN', {maxWidth: 11}); // T 5
                  
                  // 52 asignaturas
                  const calificacionesM = [
                    {
                      'asignatura': 'Matemáticas',
                      'horas': '50',
                      'calificacion': 'AU',
                      'numero': '10'
                    },{
                      'asignatura': 'Lenguaje',
                      'horas': '75',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Ciencias',
                      'horas': '35',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                    {
                      'asignatura': 'Historia',
                      'horas': '91',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Geografía',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Arte',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación Física',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Inglés',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Religión',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Tecnología',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Cultura',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'AU',
                      'numero': '10'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '446',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                    {
                      'asignatura': 'Matemáticas',
                      'horas': '50',
                      'calificacion': 'AU',
                      'numero': '10'
                    },{
                      'asignatura': 'Lenguaje',
                      'horas': '75',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Ciencias',
                      'horas': '35',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                    {
                      'asignatura': 'Historia',
                      'horas': '91',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Geografía',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Arte',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación Física',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Inglés',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Religión',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Tecnología',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Cultura',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Deportes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Artes',
                      'horas': '50',
                      'calificacion': 'DE',
                      'numero': '9'
                    },
                    {
                      'asignatura': 'Educación',
                      'horas': '50',
                      'calificacion': 'SA',
                      'numero': '8'
                    },
                  ];
                  doc.setFont('avantgarde', 'normal');
                  var countCalificacion = 0;
                  var countAsignatura = 0;
                  var alturaNew = 0;
                  calificacionesM.forEach((asig,i) =>{
                    doc.line(margins.left, margins.top + 50 + (i*3), margins.left, margins.top + 53 + (i*3), 'FD'); // | 1
                    doc.line(margins.left, margins.top + 53 + (i*3), margins.left + 146, margins.top + 53 + (i*3), 'FD') // - 2
                    doc.line(margins.left + 110, margins.top + 50 + (i*3), margins.left + 110, margins.top + 53 + (i*3), 'FD'); // | 3
                    doc.line(margins.left + 122, margins.top + 50 + (i*3), margins.left + 122, margins.top + 53 + (i*3), 'FD'); // | 4
                    doc.line(margins.left + 134, margins.top + 50 + (i*3), margins.left + 134, margins.top + 53 + (i*3), 'FD'); // | 5
                    doc.line(margins.left + 146, margins.top + 50 + (i*3), margins.left + 146, margins.top + 53 + (i*3), 'FD'); // | 6
                    doc.setFontSize(8);
                    doc.text(asig.asignatura, margins.left + 5, margins.top + 52.4 + (i*3), { align: 'left' }); // T 1
                    doc.setFontSize(7);
                    doc.text(asig.horas, margins.left + 116, margins.top + 52.4 + (i*3), { align: 'center' }); // T 2
                    doc.text(asig.numero, margins.left + 128, margins.top + 52.4 + (i*3), { align: 'center' }); // T 4
                    doc.text(asig.calificacion, margins.left + 138.3, margins.top + 52.4 + (i*3), { align: 'left' }); // T 3
                    
                    countCalificacion += parseInt(asig.numero);
                    countAsignatura = i + 1;
                    alturaNew = margins.top + 53 + (i*3);
                  })
                  //altura actual  = alturaNew;

                  doc.line(margins.left, alturaNew, margins.left, alturaNew + 3, 'FD'); // | 1
                  doc.line(margins.left, alturaNew + 3, margins.left + 146, alturaNew + 3, 'FD') // - 2
                  doc.line(margins.left + 122, alturaNew, margins.left + 122, alturaNew + 3, 'FD'); // | 3
                  doc.line(margins.left + 146, alturaNew, margins.left + 146, alturaNew + 3, 'FD'); // | 4
                  doc.setFont('avantgarde', 'bold');
                  doc.text(margins.left + 48, alturaNew + 2.3, 'Promedio Final'); 
                  doc.setFont('avantgarde', 'normal');
                  doc.text(margins.left + 132.5, alturaNew + 2.3, (countCalificacion/countAsignatura).toFixed(1).toString()); 

                  
                  doc.addPage();

                  //competencias
                  const competenciasEspecificas = [
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. ',
                    },
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. ',
                    },
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem.',
                    },
                  ]
                  const competenciasGenericas = [
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. ',
                    },
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem. ',
                    },
                    {
                      'competencia': 'lorem ipsum dolor sit amet consectetur adipisicing elit. Quisquam, quidem.',
                    },
                  ]

                  let countCompetencias = 0;
                  let competenciasESentencia = ''
                  let alturaESentencia = 0;
                  competenciasEspecificas.forEach((comp) =>{
                    competenciasESentencia += comp.competencia + '\n'+ '\n'
                    comp.competencia.length > 117 
                    ? alturaESentencia += parseInt(Math.ceil(comp.competencia.length/115))
                    : alturaESentencia += 2
                    countCompetencias += 1;
                  })

                  let competenciasGSentencia = ''
                  let alturaGSentencia = 0;
                  competenciasGenericas.forEach((comp) =>{
                    competenciasGSentencia += comp.competencia + '\n'+ '\n'
                    comp.competencia.length > 117
                    ? alturaGSentencia += parseInt(Math.ceil(comp.competencia.length/115))
                    : alturaGSentencia += 2
                    countCompetencias += 1;
                  })


                  doc.line(margins.left, margins.top, margins.left, margins.top + 6, 'FD'); // | 1
                  doc.line(margins.left, margins.top, margins.left + 146, margins.top, 'FD'); // - 2
                  doc.line(margins.left + 146, margins.top, margins.left + 146, margins.top + 6, 'FD'); // | 3
                  doc.line(margins.left, margins.top + 3, margins.left + 146, margins.top + 3, 'FD'); // - 4
                  doc.line(margins.left, margins.top + 6, margins.left + 146, margins.top + 6, 'FD'); // - 5

                  doc.setFontSize(8);
                  doc.setFont('arial', 'bold');
                  doc.text(margins.left + 21, margins.top + 2.5, 'COMPETENCIAS PROFESIONALES QUE AVALA EL PRESIDENTE CERTIFICADO');
                  doc.text(margins.left + 5, margins.top + 5.4, 'Competencias Especificas ');

                  doc.setFont('arial', 'normal');
                  doc.text(competenciasESentencia, margins.left + 5, margins.top + 9 , { align: 'left', maxWidth: 140 });
                  
                  doc.line(margins.left, margins.top + 6, margins.left, margins.top + (alturaESentencia * 5), 'FD'); // | 1
                  doc.line(margins.left + 146, margins.top + 6, margins.left + 146, margins.top + (alturaESentencia * 5), 'FD'); // | 2

                  alturaNew = margins.top + (alturaESentencia * 5);
                  doc.line(margins.left, alturaNew, margins.left + 146, alturaNew, 'FD'); // - 1
                  doc.line(margins.left, alturaNew, margins.left, alturaNew + 3, 'FD'); // | 2
                  doc.line(margins.left + 146, alturaNew, margins.left + 146, alturaNew + 3, 'FD'); // | 2
                  doc.line(margins.left, alturaNew + 3, margins.left + 146, alturaNew + 3, 'FD'); // - 4

                  doc.setFont('arial', 'bold');
                  doc.text(margins.left + 5, alturaNew + 2.4, 'Competencias Genéricas');

                  doc.setFont('arial', 'normal');
                  doc.text(competenciasGSentencia, margins.left + 5, alturaNew + 6 , { align: 'left', maxWidth: 140 });
                  
                  doc.line(margins.left, alturaNew + 3, margins.left, alturaNew + (alturaGSentencia * 5), 'FD'); // | 1
                  doc.line(margins.left + 146, alturaNew + 3, margins.left + 146, alturaNew + (alturaGSentencia * 5), 'FD'); // | 2
                  
                  alturaNew = alturaNew + (alturaGSentencia * 5);
                  doc.line(margins.left, alturaNew, margins.left + 146, alturaNew, 'FD'); // - 3


                  let dia, mes, anio;
                  new Date().getDate().toString().length == 1 ? dia = '0' + new Date().getDate().toString() : dia = new Date().getDate().toString();
                  const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                  mes = meses[new Date().getMonth()]
                  anio = new Date().getFullYear().toString();
                  const text1 = `El presente certificado ampara ${countAsignatura} asignaturas de un total de ${countAsignatura} y ${countCompetencias} competencias profesionales de un total de ${countCompetencias}.`
                  const text2 = `Expedido en El Carmen Xalpatlahuaya de Huamantla, Tlaxcala., a los ${dia} dias del mes de ${mes} del año ${anio}`

                  const alturaText1 = parseInt(Math.ceil(text1.length/115)) * 4;
                  const alturaText2 = parseInt(Math.ceil(text2.length/115)) * 7;

                  doc.setFontSize(8);
                  doc.setFont('avantgarde', 'normal');
                  doc.text(margins.left + 5, alturaNew + alturaText1 , text1, { align: 'left', maxWidth: 140 });
                  doc.text(margins.left + 5, alturaNew + alturaText1 + alturaText2 + 3, text2, { align: 'left', maxWidth: 140 });

                  alturaNew = alturaNew + alturaText1 + alturaText2 + 3;

                  //firmas
                  doc.line(margins.left, alturaNew + 20, margins.left + 65, alturaNew + 20, 'FD'); // - 1
                  doc.line(margins.left + 85, alturaNew + 20, margins.left + 146, alturaNew + 20, 'FD'); // - 2

                  doc.text(margins.left + 32.5, alturaNew + 24, 'Arq. Alfredo Ajuria Huerta', { align: 'center', maxWidth: 55 });
                  doc.text(margins.left + 117.5, alturaNew + 24, 'M. en C. Yesenia Ricón Enríquez', { align: 'center', maxWidth: 135 });

                  doc.text(margins.left + 32.5, alturaNew + 29, 'Jefe del Departamento de Servicios Escolares', { align: 'center', maxWidth: 55 });
                  doc.text(margins.left + 117.5, alturaNew + 29, `Directora de la Carrera de ${dataA.carrera_titulacion} Area ${dataA.area_carrera_titulacion}`, { align: 'center', maxWidth: 135 });
                  

                  //Ultima tabla
                  const newMargins = {
                    left: margins.left - 10,
                    right: margins.left + 146 + 10,
                  }
                  doc.line(newMargins.left, alturaNew + 50, newMargins.right, alturaNew + 50, 'FD'); // - 1
                  doc.line(newMargins.left, alturaNew + 50, newMargins.left, alturaNew + 50 + 10, 'FD'); // | 2
                  doc.line(newMargins.right, alturaNew + 50, newMargins.right, alturaNew + 50 + 10, 'FD'); // | 3
                  doc.line(newMargins.left, alturaNew + 54, newMargins.right, alturaNew + 54, 'FD'); // - 4
                  doc.line(newMargins.left, alturaNew + 57, newMargins.right, alturaNew + 57, 'FD'); // - 5
                  doc.line(newMargins.left, alturaNew + 60, newMargins.right, alturaNew + 60, 'FD'); // - 6

                  doc.line(newMargins.left + 30, alturaNew + 54, newMargins.left + 30, alturaNew + 60, 'FD'); // | 7
                  doc.line(newMargins.left + 60, alturaNew + 54, newMargins.left + 60, alturaNew + 60, 'FD'); // | 8
                  doc.line(newMargins.left + 68, alturaNew + 54, newMargins.left + 68, alturaNew + 60, 'FD'); // | 9
                  doc.line(newMargins.left + 98, alturaNew + 54, newMargins.left + 98, alturaNew + 60, 'FD'); // | 10
                  doc.line(newMargins.left + 102, alturaNew + 54, newMargins.left + 102, alturaNew + 60, 'FD'); // | 11
                  doc.line(newMargins.left + 132, alturaNew + 54, newMargins.left + 132, alturaNew + 60, 'FD'); // | 12
                  doc.line(newMargins.left + 136, alturaNew + 54, newMargins.left + 136, alturaNew + 60, 'FD'); // | 13
                  
                  doc.setFontSize(5);
                  doc.setFont('arial', 'bold');
                  doc.text(newMargins.left + 75, alturaNew + 53, 'DESCRIPCIÓN DE LA ESCALA ALFANUMÉRICA', { align: 'center', maxWidth: newMargins.right }); // T 1

                  doc.setFont('arial', 'normal');
                  doc.text(newMargins.left + 2, alturaNew + 56.5, 'Asignaturas No integradoras', { align: 'left' }); // T 2
                  doc.text(newMargins.left + 2, alturaNew + 59.5, 'Asignaturas Integradoras', { align: 'left' }); // T 3

                  doc.text(newMargins.left + 30 + 2, alturaNew + 56.5, 'AU = Autónomo', { align: 'left' }); // T 4
                  doc.text(newMargins.left + 30 + 2, alturaNew + 59.5, 'CA = Competente Autónomo', { align: 'left' }); // T 5

                  doc.text(newMargins.left + 60 + 3, alturaNew + 56.5, '10', { align: 'left' }); // T 6
                  doc.text(newMargins.left + 60 + 3, alturaNew + 59.5, '10', { align: 'left' }); // T 7

                  doc.text(newMargins.left + 68 + 2, alturaNew + 56.5, 'DE = Destacado', { align: 'left' }); // T 8
                  doc.text(newMargins.left + 68 + 2, alturaNew + 59.5, 'CD = Competente Destacado', { align: 'left' }); // T 9

                  doc.text(newMargins.left + 98 + 1.5, alturaNew + 56.5, '9', { align: 'left' }); // T 10
                  doc.text(newMargins.left + 98 + 1.5, alturaNew + 59.5, '9', { align: 'left' }); // T 11

                  doc.text(newMargins.left + 102 + 2, alturaNew + 56.5, 'SA = Satisfactorio', { align: 'left' }); // T 12
                  doc.text(newMargins.left + 102 + 2, alturaNew + 59.5, 'CO = Competente', { align: 'left' }); // T 13

                  doc.text(newMargins.left + 132 + 1.5, alturaNew + 56.5, '8', { align: 'left' }); // T 14
                  doc.text(newMargins.left + 132 + 1.5, alturaNew + 59.5, '8', { align: 'left' }); // T 15

                  doc.text(newMargins.left + 136 + 2, alturaNew + 56.5, 'NA = No Acreditado', { align: 'left' }); // T 16
                  doc.text(newMargins.left + 136 + 2, alturaNew + 59.5, 'NA = No Acreditado', { align: 'left' }); // T 17



                  doc.save(dataA.matricula_alumno_titulacion+'_'+new Date().getTime()+'_CT.pdf');
                } catch (error) {
                  console.log(error);
                }

                $('#fieldsNewCertificado').addClass('d-none');
                $('#btnGenerar').addClass('d-none');
                $('option', $('#selectA')).each(function() {
                  this.getAttribute('value') == $('#selectA').val() && $(this).remove();
                })
                setTimeout(() => {
                  $('#form')[0].reset();
                  $('#selectA').val('');
                  $('#select2-selectA-container').text('Ingrese la matricula del alumno');
                }, 500);
                $('html, body').animate({ scrollTop: 0 }, 'slow');
              },
              error: function(err) {
                Toast.fire({
                  icon: 'error',
                  title: ' Error inesperado al generar el certificado'
                })
                console.log(err);
              }
            })
          }else{
            Toast.fire({
              icon: 'error',
              title: ' Acepte que los datos esten correctos'
            });
          }
        }
                    
      })
    
    }
  )
</script>


<script>
  $(function () {
    //Initialize Select2 Elements
    $('.select2').select2()

    //Initialize Select2 Elements
    $('.select2bs4').select2({
      theme: 'bootstrap4'
    })

    //Datemask dd/mm/yyyy
    $('#datemask').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })
    //Datemask2 mm/dd/yyyy
    $('#datemask2').inputmask('mm/dd/yyyy', { 'placeholder': 'mm/dd/yyyy' })
    //Money Euro
    $('[data-mask]').inputmask()

    //Date range picker
    $('#reservationdate').datetimepicker({
        format: 'L'
    });
    //Date range picker
    $('#reservation').daterangepicker()
    //Date range picker with time picker
    $('#reservationtime').daterangepicker({
      timePicker: true,
      timePickerIncrement: 30,
      locale: {
        format: 'MM/DD/YYYY hh:mm A'
      }
    })
    //Date range as a button
    $('#daterange-btn').daterangepicker(
      {
        ranges   : {
          'Today'       : [moment(), moment()],
          'Yesterday'   : [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Last 7 Days' : [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month'  : [moment().startOf('month'), moment().endOf('month')],
          'Last Month'  : [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        startDate: moment().subtract(29, 'days'),
        endDate  : moment()
      },
      function (start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'))
      }
    )

    //Timepicker
    $('#timepicker').datetimepicker({
      format: 'LT'
    })

    //Bootstrap Duallistbox
    $('.duallistbox').bootstrapDualListbox()

    //Colorpicker
    $('.my-colorpicker1').colorpicker()
    //color picker with addon
    $('.my-colorpicker2').colorpicker()

    $('.my-colorpicker2').on('colorpickerChange', function(event) {
      $('.my-colorpicker2 .fa-square').css('color', event.color.toString());
    });

    $("input[data-bootstrap-switch]").each(function(){
      $(this).bootstrapSwitch('state', $(this).prop('checked'));
    });

  })
</script>

{% endblock javascripts %}
